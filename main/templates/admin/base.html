{% load static sass_tags %}
<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{% block title %}Bảng điều khiển - Global English{% endblock %}</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@7.2.3/css/flag-icons.min.css">
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
            crossorigin="anonymous"
        />
        <link rel="stylesheet" href="{% sass_src 'admin/scss/base.scss' %}" />
        {% block extra_css %}{% endblock %}
    </head>
    <body>
        <div class="layout">
            <aside class="layout__sidebar" id="sidebar">
                <div class="layout__brand" aria-label="{{ brand_name|default:'Global English' }}">
                    <img
                        src="{% static 'admin/images/logo.svg' %}"
                        alt="{{ brand_name|default:'Global English' }}"
                        class="layout__brand-logo"
                    />
                </div>
                <nav>
                    {% block sidebar_links %}
                    <div class="sidebar-section">
                        <p class="sidebar-section__title">Tổng quan</p>
                        <ul class="layout__nav">
                            <li>
                                <a class="{% block sidebar_dashboard_active %}{% endblock %}" href="{% block sidebar_dashboard_href %}#{% endblock %}">
                                    <i class="fas fa-chart-line"></i>
                                    Dashboard
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_activity_active %}{% endblock %}" href="{% block sidebar_activity_href %}#{% endblock %}">
                                    <i class="fas fa-clock-rotate-left"></i>
                                    Nhật ký hoạt động
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <p class="sidebar-section__title">Quản trị vận hành</p>
                        <ul class="layout__nav">
                            <li>
                                <a class="{% block sidebar_learners_active %}{% endblock %}" href="{% block sidebar_learners_href %}#{% endblock %}">
                                    <i class="fas fa-user-graduate"></i>
                                    Học viên
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_teachers_active %}{% endblock %}" href="{% block sidebar_teachers_href %}#{% endblock %}">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                    Giáo viên
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_hr_active %}{% endblock %}" href="{% block sidebar_hr_href %}#{% endblock %}">
                                    <i class="fas fa-people-group"></i>
                                    Nhân sự &amp; Tài chính
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <p class="sidebar-section__title">Sales &amp; Finance</p>
                        <ul class="layout__nav">
                            <li>
                                <a class="{% block sidebar_enrollment_active %}{% endblock %}" href="{% block sidebar_enrollment_href %}#{% endblock %}">
                                    <i class="fas fa-file-signature"></i>
                                    Đơn đăng ký / Enrollment
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_invoice_active %}{% endblock %}" href="{% block sidebar_invoice_href %}#{% endblock %}">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                    Hóa đơn &amp; Thanh toán
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_cashflow_active %}{% endblock %}" href="{% block sidebar_cashflow_href %}#{% endblock %}">
                                    <i class="fas fa-coins"></i>
                                    Thu – Chi / Quỹ
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_coupon_active %}{% endblock %}" href="{% block sidebar_coupon_href %}#{% endblock %}">
                                    <i class="fas fa-ticket"></i>
                                    Ưu đãi / Coupon
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_refund_active %}{% endblock %}" href="{% block sidebar_refund_href %}#{% endblock %}">
                                    <i class="fas fa-rotate-left"></i>
                                    Hoàn tiền
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_finance_report_active %}{% endblock %}" href="{% block sidebar_finance_report_href %}#{% endblock %}">
                                    <i class="fas fa-chart-pie"></i>
                                    Báo cáo
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <p class="sidebar-section__title">Content &amp; Marketing</p>
                        <ul class="layout__nav">
                            <li>
                                <a class="{% block sidebar_posts_active %}{% endblock %}" href="{% block sidebar_posts_href %}#{% endblock %}">
                                    <i class="fas fa-pen-to-square"></i>
                                    Bài viết
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_banner_active %}{% endblock %}" href="{% block sidebar_banner_href %}#{% endblock %}">
                                    <i class="fas fa-image"></i>
                                    Banner
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_testimonials_active %}{% endblock %}" href="{% block sidebar_testimonials_href %}#{% endblock %}">
                                    <i class="fas fa-comment-dots"></i>
                                    Testimonials
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_faq_active %}{% endblock %}" href="{% block sidebar_faq_href %}#{% endblock %}">
                                    <i class="fas fa-circle-question"></i>
                                    FAQ
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <p class="sidebar-section__title">QA &amp; Support</p>
                        <ul class="layout__nav">
                            <li>
                                <a class="{% block sidebar_ticket_active %}{% endblock %}" href="{% block sidebar_ticket_href %}#{% endblock %}">
                                    <i class="fas fa-headset"></i>
                                    Ticket hỗ trợ
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_feedback_active %}{% endblock %}" href="{% block sidebar_feedback_href %}#{% endblock %}">
                                    <i class="fas fa-star-half-stroke"></i>
                                    Feedback / Đánh giá
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <p class="sidebar-section__title">Analytics</p>
                        <ul class="layout__nav">
                            <li>
                                <a class="{% block sidebar_kpi_active %}{% endblock %}" href="{% block sidebar_kpi_href %}#{% endblock %}">
                                    <i class="fas fa-gauge-high"></i>
                                    KPI
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_funnel_active %}{% endblock %}" href="{% block sidebar_funnel_href %}#{% endblock %}">
                                    <i class="fas fa-filter-circle-dollar"></i>
                                    Funnel
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_retention_active %}{% endblock %}" href="{% block sidebar_retention_href %}#{% endblock %}">
                                    <i class="fas fa-arrows-rotate"></i>
                                    Retention
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_cohort_active %}{% endblock %}" href="{% block sidebar_cohort_href %}#{% endblock %}">
                                    <i class="fas fa-layer-group"></i>
                                    Cohort
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="sidebar-section">
                        <p class="sidebar-section__title">System &amp; Security</p>
                        <ul class="layout__nav">
                            <li>
                                <a class="{% block sidebar_user_role_active %}{% endblock %}" href="{% block sidebar_user_role_href %}#{% endblock %}">
                                    <i class="fas fa-users-cog"></i>
                                    Người dùng &amp; Quyền
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_audit_active %}{% endblock %}" href="{% block sidebar_audit_href %}#{% endblock %}">
                                    <i class="fas fa-shield-halved"></i>
                                    Nhật ký / Audit
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_integration_active %}{% endblock %}" href="{% block sidebar_integration_href %}#{% endblock %}">
                                    <i class="fas fa-plug"></i>
                                    Tích hợp (SMTP, SMS, Zalo OA…)
                                </a>
                            </li>
                            <li>
                                <a class="{% block sidebar_config_active %}{% endblock %}" href="{% block sidebar_config_href %}#{% endblock %}">
                                    <i class="fas fa-sliders"></i>
                                    Cấu hình / Constance / Feature flags
                                </a>
                            </li>
                        </ul>
                    </div>
                    {% endblock %}
                </nav>
                <div class="layout__sidebar-footer">
                    {% block sidebar_footer %}{% endblock %}
                </div>
            </aside>

            <header class="layout__navbar">
                <div class="layout__navbar-left">
                    <button
                        class="btn btn-outline-secondary d-lg-none"
                        type="button"
                        aria-controls="sidebar"
                        id="sidebarToggle"

                        aria-expanded="false"

                        aria-label="Mở/đóng menu"
                    >
                        <i class="fas fa-bars"></i>
                    </button>
                    <button
                        class="icon-button icon-button--ghost layout__navbar-controls-toggle d-inline-flex d-lg-none"
                        type="button"
                        id="navbarControlToggle"
                        aria-label="Hiển thị thiết lập nhanh"
                        aria-expanded="false"
                    >
                        <i class="fas fa-ellipsis-vertical"></i>
                    </button>
                    <div class="layout__navbar-brand">
                        <button
                            class="icon-button icon-button--ghost layout__navbar-collapse-toggle d-none d-lg-inline-flex"
                            type="button"
                            id="sidebarCollapseToggle"
                            aria-label="Thu gọn/ mở rộng sidebar"
                            aria-pressed="false"
                        >
                            <i class="fas fa-angles-left"></i>
                        </button>
                    </div>
                </div>

                <form method="get" action="{% block navbar_search_action %}#{% endblock %}" class="layout__search" role="search">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text" id="search-addon">
                            <i class="fas fa-search"></i>
                        </span>
                        <input
                            type="search"
                            class="form-control"
                            placeholder="Tìm kiếm nhanh..."
                            aria-label="Tìm kiếm nhanh"
                            aria-describedby="search-addon"
                            name="q"
                            value="{{ request.GET.q|default:'' }}"
                        />
                    </div>
                </form>

                <div class="layout__navbar-right">
                    <div class="navbar-control dropdown">
                        <button
                            class="icon-button icon-button--ghost"
                            type="button"
                            id="languageDropdown"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            aria-label="Đổi ngôn ngữ"
                        >
                            <i class="fas fa-globe"></i>
                        </button>
                        <span class="navbar-control__label">Ngôn ngữ</span>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="languageDropdown">
                            <li class="dropdown-header">Chọn ngôn ngữ</li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="{% block lang_vi_href %}#{% endblock %}">
                                    <span class="fi fi-vn"></span> Tiếng Việt
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center gap-2" href="{% block lang_en_href %}#{% endblock %}">
                                    <span class="fi fi-gb"></span> English
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="navbar-control navbar-control--toggle">
                        <button
                            class="icon-button"
                            type="button"
                            id="themeToggle"
                            aria-label="Chuyển chế độ sáng/tối"
                            aria-pressed="false"
                        >
                            <i class="fas fa-moon"></i>
                        </button>
                        <span class="navbar-control__label">Giao diện</span>
                    </div>

                    {% with task_count=tasks_pending_count|default:0 %}
                    <div class="navbar-control dropdown{% if task_count %} navbar-control--alert{% endif %}">
                        <button
                            class="icon-button"
                            type="button"
                            id="tasksDropdown"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            aria-label="Nhiệm vụ và phê duyệt"
                        >
                            <i class="fas fa-clipboard-check"></i>
                            {% if task_count %}
                            <span class="icon-button__badge">{{ task_count }}</span>
                            {% endif %}
                        </button>
                        <span class="navbar-control__label">Nhiệm vụ</span>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-md shadow" aria-labelledby="tasksDropdown">
                            <div class="dropdown-header d-flex justify-content-between align-items-center">
                                <span>Nhiệm vụ &amp; phê duyệt</span>
                                {% if task_count %}
                                <span class="badge bg-primary">{{ task_count }} đang chờ</span>
                                {% endif %}
                            </div>
                            <div class="dropdown-divider"></div>
                            {% if tasks_pending %}
                                {% for task in tasks_pending|slice:":5" %}
                                <a class="dropdown-item" href="{{ task.href|default:'#' }}">
                                    <div class="fw-semibold">{{ task.title }}</div>
                                    <small class="text-muted">{{ task.subtitle }}</small>
                                </a>
                                {% endfor %}
                            {% else %}
                                <p class="dropdown-item text-muted mb-0">Không có nhiệm vụ nào.</p>
                            {% endif %}
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-primary" href="{% block tasks_view_all_href %}#{% endblock %}">
                                Xem tất cả nhiệm vụ
                            </a>
                        </div>
                    </div>
                    {% endwith %}

                    {% with support_count=support_unread_count|default:0 %}
                    <div class="navbar-control dropdown{% if support_count %} navbar-control--alert{% endif %}">
                        <button
                            class="icon-button"
                            type="button"
                            id="supportDropdown"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            aria-label="Tin nhắn và hỗ trợ"
                        >
                            <i class="fas fa-comments"></i>
                            {% if support_count %}
                            <span class="icon-button__badge">{{ support_count }}</span>
                            {% endif %}
                        </button>
                        <span class="navbar-control__label">Hỗ trợ</span>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-md shadow" aria-labelledby="supportDropdown">
                            <div class="dropdown-header">Hỗ trợ &amp; tin nhắn</div>
                            <div class="dropdown-divider"></div>
                            <p class="dropdown-item text-muted mb-0">Không có tin nhắn mới.</p>
                        </div>
                    </div>
                    {% endwith %}

                    {% with notification_count=notification_unread_count|default:0 %}
                    <div class="navbar-control dropdown{% if notification_count %} navbar-control--alert{% endif %}">
                        <button
                            class="icon-button"
                            type="button"
                            id="notificationsDropdown"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            aria-label="Thông báo"
                        >
                            <i class="fas fa-bell"></i>
                            {% if notification_count %}
                            <span class="icon-button__badge">{{ notification_count }}</span>
                            {% endif %}
                        </button>
                        <span class="navbar-control__label">Thông báo</span>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-md shadow" aria-labelledby="notificationsDropdown">
                            <div class="dropdown-header">Thông báo</div>
                            <div class="dropdown-divider"></div>
                            <p class="dropdown-item text-muted mb-0">Bạn đang cập nhật toàn bộ.</p>
                        </div>
                    </div>
                    {% endwith %}

                    <div class="navbar-control dropdown account-menu">
                        <button
                            class="account-menu__toggle"
                            type="button"
                            id="accountMenuDropdown"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                        >
                            <div class="avatar bg-primary text-white fw-semibold rounded-circle d-flex align-items-center justify-content-center">
                                {{ request.user.get_short_name|default:request.user.username|slice:":1"|upper }}
                            </div>
                        </button>
                        <span class="navbar-control__label d-none d-xl-inline">Tài khoản</span>
                        <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="accountMenuDropdown">
                            <li class="dropdown-header">
                                <div class="fw-semibold">{{ request.user.get_full_name|default:request.user.username }}</div>
                                <div class="text-muted small">{{ request.user.email|default:"Không có email" }}</div>
                            </li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="{% block account_profile_href %}#{% endblock %}"><i class="fas fa-id-badge me-2"></i>Hồ sơ của tôi</a></li>
                            <li><a class="dropdown-item" href="{% url 'admin:password_change' %}"><i class="fas fa-key me-2"></i>Đổi mật khẩu</a></li>
                            <li>
                                <a class="dropdown-item text-danger" href="{% url 'admin:logout' %}">
                                    <i class="fas fa-arrow-right-from-bracket me-2"></i>Đăng xuất
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </header>

            <main class="layout__main">
                {% block content %}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Nội dung trống</h5>
                        <p class="card-text text-muted">
                            Sử dụng block <code>content</code> trong template con để hiển thị nội dung trang quản trị.
                        </p>
                    </div>
                </div>
                {% endblock %}
            </main>

            <footer
                class="layout__footer"
                data-brand-name="{{ brand_name|default:'Global English' }}"
                data-app-version="{{ app_version|default:'v1.0.0' }}"
                data-app-environment="{{ app_environment|default:'PROD' }}"
                data-build-commit="{{ build_commit|default:'abc1234' }}"
                data-build-timestamp="{{ build_timestamp|default:'Không xác định' }}"
                data-storage-db="{{ storage_db_usage|default:'--' }}"
                data-storage-media="{{ storage_media_usage|default:'--' }}"
                data-celery-status="{{ celery_status|default:'unknown' }}"
                data-redis-status="{{ redis_status|default:'unknown' }}"
                data-smtp-status="{{ smtp_status|default:'unknown' }}"
                data-status-url="{% block footer_status_url %}{% endblock %}"
                data-status-interval="{% block footer_status_interval %}60000{% endblock %}"
                >
                {% comment %}
                Example for status URL: {% url 'admin:service_status' %}
                Interval is in milliseconds, e.g. 60000 for auto refresh every 60s
                {% endcomment %}
                <div class="layout__footer-left">
                    <span class="footer-copy">
                    &copy; <span data-footer-field="year">{% now "Y" %}</span>
                    <span data-footer-field="brand">{{ brand_name|default:"Global English" }}</span>
                    </span>
                    <span class="footer-version">
                    <span data-footer-field="version">{{ app_version|default:"v1.0.0" }}</span>
                    <span class="badge badge-env" data-footer-field="environment">
                        {{ app_environment|default:"PROD" }}
                    </span>
                    </span>
                </div>

                <div class="layout__footer-center">
                    <div class="footer-status">
                    <span class="status-indicator status-indicator--{{ celery_status|default:'unknown' }}" data-service="celery" data-status="{{ celery_status|default:'unknown' }}">
                        <span class="status-indicator__dot"></span>
                        Celery
                    </span>
                    <span class="status-indicator status-indicator--{{ redis_status|default:'unknown' }}" data-service="redis" data-status="{{ redis_status|default:'unknown' }}">
                        <span class="status-indicator__dot"></span>
                        Redis
                    </span>
                    <span class="status-indicator status-indicator--{{ smtp_status|default:'unknown' }}" data-service="smtp" data-status="{{ smtp_status|default:'unknown' }}">
                        <span class="status-indicator__dot"></span>
                        SMTP
                    </span>
                    <button id="footerStatusRefresh" type="button" class="btn btn-sm btn-outline-secondary ms-3 d-none" aria-busy="false">
                        <i class="fa-solid fa-rotate"></i> Refresh
                    </button>
                    </div>
                </div>

                <div class="layout__footer-right">
                    <span
                    class="footer-build"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="{{ build_timestamp|default:'Không xác định' }}"
                    data-footer-field="buildTimestamp"
                    >
                    Build: commit <span data-footer-field="commit">{{ build_commit|default:'abc1234' }}</span>
                    </span>
                    <span class="footer-storage">
                    Storage:
                    <span class="footer-storage__item">DB <span data-footer-field="storageDb">{{ storage_db_usage|default:'--' }}</span></span>
                    <span class="footer-storage__item">Media <span data-footer-field="storageMedia">{{ storage_media_usage|default:'--' }}</span></span>
                    </span>
                </div>
                </footer>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="{% static 'admin/js/base.js' %}"></script>
        {% block extra_js %}{% endblock %}
        <noscript>
            <div class="alert alert-warning m-3">
                Trang quản trị cần bật JavaScript để hoạt động đầy đủ (menu, theme, trạng thái hệ thống…)
            </div>
        </noscript>
    </body>
</html>

